<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>
var DELAYED_JOB_ADMIN = (function(dja, $) {

  var base_route = '<%= DelayedJobAdmin::job_status_path %>';
  var default_poll_interval_in_secs = <%= DelayedJobAdmin::default_poll_interval_in_secs %>;

  dja.poll_job = function(job_id, success, failure, processing, poll_interval) {

    success = (typeof success === 'function') ? success : function() {};
    failure = (typeof failure === 'function') ? failure : function() {};
    process = (typeof process === 'function') ? process : function() {};
    poll_interval = (typeof poll_interval !== 'undefined') ? poll_interval*1000 : default_poll_interval_in_secs*1000;
    var status_route = base_route.replace(/:id/, job_id);

    var on_status_update = function(data) {
      if(data.status==='none') {
        success(data);
      } else if(data.status==='failing') {
        failure(data);
      } else {
        if(data.status==='processing') {
          processing(data);
        }
        window.setTimeout(poll, poll_interval);
      }
    };

    var poll = function() {
      $.ajax({
        url: status_route,
        data: {},
        success: on_status_update,
        dataType: 'json'
      });
    };

    poll();
  };

  return dja;

})( DELAYED_JOB_ADMIN || {}, jQuery);
